# PDF性能监控功能说明

## 功能概述

为了解决PDF生成速度慢的问题，我们添加了详细的性能监控功能，可以精确追踪PDF生成过程中各个阶段的耗时，帮助识别性能瓶颈。

## 主要功能

### 1. 详细的时间日志
- 每个阶段都有精确的时间戳
- 显示各阶段的耗时统计
- 包含开始和结束时间

### 2. 性能监控器
- 自动记录各个阶段的耗时
- 生成详细的性能报告
- 识别最慢的阶段
- 提供性能优化建议

### 3. 日志保存
- 自动保存性能日志到文件
- 支持历史性能数据分析
- JSON格式便于后续分析

## 监控的阶段

1. **PDF_Start** - PDF生成开始
2. **Task_Start** - 任务开始执行
3. **Navigation_Start** - 开始导航到页面
4. **Navigation_Complete** - 页面导航完成
5. **Wait_Start** - 开始等待页面加载
6. **Wait_Complete** - 页面加载完成
7. **Render_Start** - 开始等待页面渲染
8. **Render_Complete** - 页面渲染完成
9. **PDF_Generation_Start** - 开始生成PDF
10. **PDF_Generation_Complete** - PDF生成完成
11. **Buffer_Conversion_Start** - 开始转换为Buffer
12. **Buffer_Conversion_Complete** - Buffer转换完成
13. **Task_Complete** - 任务完成

## 使用方法

### 1. 自动监控
PDF生成时会自动启动性能监控，无需额外配置。

### 2. 查看性能报告
每次PDF生成完成后，控制台会显示详细的性能报告，包括：
- 总耗时
- 各阶段耗时及占比
- 性能瓶颈识别
- 优化建议

### 3. 测试性能监控
```bash
# 运行测试脚本
node test-pdf-performance.js
```

## 性能报告示例

```
============================================================
📊 PDF生成性能报告
============================================================
总耗时: 4200ms
开始时间: 2024-01-01T12:00:00.000Z
结束时间: 2024-01-01T12:00:04.200Z
记录阶段数: 13

各阶段耗时:
--------------------------------------------------------
PDF_Start           :    100ms (2.38%)
Task_Start          :    700ms (16.67%)
Navigation_Start     :    800ms (19.05%)
Navigation_Complete  :    200ms (4.76%)
Wait_Start           :    500ms (11.90%)
Wait_Complete        :    100ms (2.38%)
Render_Start         :    900ms (21.43%)
Render_Complete      :    100ms (2.38%)
PDF_Generation_Start :   1400ms (33.33%)
PDF_Generation_Complete:    100ms (2.38%)
Buffer_Conversion_Start:    100ms (2.38%)
Buffer_Conversion_Complete:    100ms (2.38%)
Task_Complete        :    100ms (2.38%)

性能瓶颈:
--------------------------------------------------------
最慢阶段: PDF_Generation_Start (1400ms, 33.33%)

性能建议:
--------------------------------------------------------
⚠️  PDF_Generation_Start 阶段占用了 33.33% 的时间，建议优化
============================================================
```

## 日志文件

性能日志会自动保存到 `logs/` 目录下，文件名格式为：
`pdf-performance-YYYY-MM-DDTHH-mm-ss-sssZ.json`

日志文件包含：
- 时间戳
- 性能报告
- 详细的阶段日志

## 性能优化建议

### 1. 如果PDF生成阶段耗时过长
- 检查页面复杂度
- 优化CSS和JavaScript
- 减少图片和字体数量

### 2. 如果页面渲染阶段耗时过长
- 优化页面加载速度
- 减少外部资源依赖
- 使用CDN加速

### 3. 如果导航阶段耗时过长
- 检查网络连接
- 优化服务器响应速度
- 考虑使用缓存

### 4. 如果总耗时超过10秒
- 检查页面是否过于复杂
- 考虑分页生成PDF
- 优化页面资源

## 注意事项

1. 性能监控会略微增加内存使用
2. 日志文件会随时间增长，建议定期清理
3. 在生产环境中可以关闭详细日志以提高性能
4. 性能数据仅用于分析，不影响PDF生成质量

## 故障排除

### 如果看不到性能报告
- 检查控制台输出
- 确认PDF生成是否成功
- 查看错误日志

### 如果日志文件没有生成
- 检查logs目录权限
- 确认磁盘空间充足
- 查看文件系统错误

### 如果性能数据不准确
- 检查系统时间是否正确
- 确认没有时区问题
- 重启应用重新测试 